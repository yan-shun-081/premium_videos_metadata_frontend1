<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Secure Encrypted Login + Upload Portal</title>

<style>
  :root {
    --primary: #6366f1;
    --secondary: #64748b;
    --accent: #f472b6;
    --success: #22c55e;
    --error: #ef4444;
    --bg1: #0f172a;
    --bg2: #1e293b;
    --card: #f9fafb;
  }
  body {
    font-family: 'Poppins', system-ui, sans-serif;
    background: linear-gradient(135deg, var(--bg1), var(--bg2));
    color: #0f172a;
    margin: 0;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    overflow-x: hidden;
    position: relative;
  }
  .gradient-bg {
    position: fixed;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: radial-gradient(circle at 50% 50%, #60a5fa40, #6366f140, #f472b640, transparent);
    filter: blur(90px);
    z-index: 0;
    animation: float 8s infinite ease-in-out alternate;
    pointer-events: none;
  }
  @keyframes float {
    0% { transform: translate(0, 0); opacity: 0.8; }
    50% { transform: translate(5%, -5%); opacity: 1; }
    100% { transform: translate(-5%, 5%); opacity: 0.8; }
  }
  .wrap { width: 95%; max-width: 480px; position: relative; z-index: 2; }
  .card {
    background: var(--card);
    border-radius: 18px;
    padding: 26px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.25);
    margin-bottom: 24px;
    position: relative;
    z-index: 2;
    animation: fadeIn 0.7s ease;
  }
  @keyframes fadeIn { from {opacity: 0; transform: translateY(20px) scale(0.97);} to {opacity: 1; transform: translateY(0) scale(1);} }
  h2 { text-align: center; color: var(--primary); margin-bottom: 16px; font-weight: 700; }
  label { display: block; margin-top: 10px; font-weight: 600; color: #334155; }
  input, select, button { font-family: inherit; }
  input, select {
    width: 100%; padding: 10px 12px; border-radius: 10px;
    border: 1px solid #cbd5e1; box-sizing: border-box;
    margin-top: 6px; font-size: 0.95rem; background: #fff;
    transition: box-shadow 0.2s, border 0.2s;
  }
  input:focus, select:focus {
    outline: none; border: 1px solid var(--primary); box-shadow: 0 0 8px var(--primary);
  }
  button {
    background: linear-gradient(135deg, var(--primary), var(--accent));
    color: white; font-weight: 600; border: 0; border-radius: 10px;
    padding: 12px 14px; cursor: pointer; margin-top: 16px; width: 100%;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  button:hover { transform: scale(1.03); box-shadow: 0 0 14px rgba(99,102,241,0.5); }
  button.secondary { background: var(--secondary); }
  .error { color: var(--error); font-weight: 600; }
  .success { color: var(--success); font-weight: 600; }
  pre { background: #0f172a; color: #e2e8f0; border-radius: 10px; padding: 12px; overflow-x: auto; }
  .hidden { display: none; }
</style>
</head>
<body>
<div class="gradient-bg"></div>

<div class="wrap">
  <div class="card" id="loginCard">
    <h2>üîê Secure Login</h2>
    <label>Username</label>
    <input id="loginUser" type="text" placeholder="Enter username" />
    <label>Password</label>
    <input id="loginPass" type="password" placeholder="Enter password" />
    <button id="loginBtn">Login</button>
    <p id="loginStatus"></p>
  </div>

  <div class="card hidden" id="appCard">
    <h2>üì§ Upload Metadata</h2>
    <label>Type</label>
    <select id="type">
      <option value="video">Video</option>
      <option value="pdf">PDF</option>
    </select>

    <label>Archive URL</label>
    <input id="archiveContentUrl" type="text" placeholder="Enter content URL" />

    <label>Archive Image URL</label>
    <input id="archiveImageUrl" type="text" placeholder="Enter image URL" />

    <label>Title</label>
    <input id="title" type="text" placeholder="Enter title" />

    <label>Username</label>
    <input id="postUsername" type="text" readonly />

    <label>Phone (optional)</label>
    <input id="phoneNumber" type="text" placeholder="+91..." />

    <button id="postBtn">üöÄ Post Metadata</button>
    <button id="logoutBtn" class="secondary">Logout</button>

    <h3>Response</h3>
    <pre id="responseArea">‚Äî</pre>
  </div>
</div>

<iframe src="bridge.html" id="bridgeFrame" style="display:none;"></iframe>

<script>
/* --- Bridge Communication --- */
function sendToBridge(type, data = {}) {
  const frame = document.getElementById("bridgeFrame").contentWindow;
  frame.postMessage({ type, ...data }, "*");
}

/* --- Backend URL --- */
const backendUrl = "https://premium_videos_metadata_backend.ajaia-backend.workers.dev/upload";

/* --- Login --- */
document.getElementById('loginBtn').addEventListener('click', () => {
  const user = document.getElementById('loginUser').value.trim();
  const pass = document.getElementById('loginPass').value.trim();
  if (user && pass) {
    document.getElementById('loginCard').classList.add('hidden');
    document.getElementById('appCard').classList.remove('hidden');
    document.getElementById('postUsername').value = user;
    document.getElementById('loginStatus').textContent = '';
  } else {
    document.getElementById('loginStatus').textContent = '‚ö†Ô∏è Enter username & password';
  }
});

/* --- Logout --- */
document.getElementById('logoutBtn').addEventListener('click', () => {
  document.getElementById('appCard').classList.add('hidden');
  document.getElementById('loginCard').classList.remove('hidden');
});

/* --- Extraction Logic --- */
async function extractMetadataAndLinks(url, type) {
  const proxies = [
    "https://corsproxy.io/?",
    "https://api.allorigins.win/raw?url=",
    "https://thingproxy.freeboard.io/fetch/"
  ];

  for (const proxy of proxies) {
    try {
      console.log("üåê Trying proxy:", proxy);
      const response = await fetch(proxy + encodeURIComponent(url));
      if (!response.ok) continue;
      const html = await response.text();
      const doc = new DOMParser().parseFromString(html, "text/html");
      const links = [...doc.querySelectorAll("a, source, video, img")]
        .map(el => el.src || el.href || "")
        .filter(Boolean);

      const find = (re) => links.find(l => re.test(l));
      const mp4 = find(/\.mp4(\?|$)/i);
      const pdf = find(/\.pdf(\?|$)/i);
      const img = find(/\.(jpg|jpeg|png)(\?|$)/i);

      return {
        archiveContentUrl: type === "video" ? (mp4 || url) : (pdf || url),
        archiveImageUrl: img || "",
      };
    } catch (e) {
      console.warn("Proxy failed:", proxy, e);
    }
  }
  throw new Error("All proxies failed");
}

/* --- Post Metadata --- */
document.getElementById('postBtn').addEventListener('click', async () => {
  const type = document.getElementById('type').value;
  const contentUrl = document.getElementById('archiveContentUrl').value.trim();
  const imageUrl = document.getElementById('archiveImageUrl').value.trim();
  const title = document.getElementById('title').value.trim();
  const username = document.getElementById('postUsername').value.trim();
  const phone = document.getElementById('phoneNumber').value.trim();
  const respArea = document.getElementById('responseArea');

  if (!contentUrl || !title || !username) {
    respArea.textContent = "‚ö†Ô∏è Missing required fields.";
    return;
  }

  respArea.textContent = "üîç Extracting metadata...";
  try {
    const extracted = await extractMetadataAndLinks(contentUrl, type);
    const payload = {
      archive_content_url: extracted.archiveContentUrl || contentUrl,
      archive_image_url: extracted.archiveImageUrl || imageUrl,
      title: title || "Untitled",
      username: username || "Unknown",
      phone_number: phone || "",
      type: type || "video"
    };

    console.log("üì¶ Payload:", payload);
    respArea.textContent = "üöÄ Uploading...";

    const res = await fetch(backendUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const text = await res.text();
    if (res.ok) {
      respArea.textContent = "‚úÖ Success:\n" + text;
    } else {
      respArea.textContent = "‚ùå Error " + res.status + ":\n" + text;
    }
  } catch (err) {
    respArea.textContent = "‚ùå Extraction or upload failed: " + err.message;
    console.error(err);
  }
});
</script>
</body>
</html>
